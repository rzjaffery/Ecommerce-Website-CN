{% extends 'base.html' %}

{% block title %}Customer Support - Online Shop{% endblock %}

{% block extra_css %}
<style>
    .chat-list {
        height: 500px;
        overflow-y: auto;
    }
    .chat-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .chat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .chat-card.active {
        border-left: 4px solid #007bff;
    }
    .unread-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .support-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
    }
    .online-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .online {
        background-color: #28a745;
    }
    .offline {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Customer Support</h2>
        </div>
        <div class="col-md-4 text-end">
            {% if is_support %}
                <div class="form-check form-switch d-inline-block me-3">
                    <input class="form-check-input" type="checkbox" id="supportStatus" {% if request.user.support_profile.is_online %}checked{% endif %}>
                    <label class="form-check-label" for="supportStatus">Available</label>
                </div>
                <span id="statusIndicator" class="online-indicator {% if request.user.support_profile.is_online %}online{% else %}offline{% endif %}"></span>
            {% else %}
                <button class="btn btn-primary" id="startNewChat">
                    <i class="fas fa-comments me-2"></i>Start New Chat
                </button>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{% if is_support %}Active Chats{% else %}Your Chats{% endif %}</h5>
                </div>
                <div class="card-body p-0 chat-list">
                    <div id="chatRoomsList">
                        {% if chat_rooms %}
                            {% for room in chat_rooms %}
                                <div class="chat-card p-3 border-bottom position-relative" data-room-id="{{ room.room_id }}">
                                    <h5 class="mb-1">{{ room.name }}</h5>
                                    <p class="text-muted mb-1">
                                        {% if is_support %}
                                            User: {{ room.user.username }}
                                        {% else %}
                                            {% if room.support_staff %}
                                                Support: {{ room.support_staff.username }}
                                            {% else %}
                                                Waiting for support...
                                            {% endif %}
                                        {% endif %}
                                    </p>
                                    <small class="text-muted">{{ room.updated_at|date:"M d, Y H:i" }}</small>
                                    <span class="unread-badge badge bg-danger d-none">0</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                {% if is_support %}
                                    No active chats at the moment.
                                {% else %}
                                    You don't have any active chats.
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card chat-window">
                <div class="card-header bg-light">
                    <h5 class="mb-0" id="chatRoomTitle">Select a chat or start a new conversation</h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-4x mb-3 text-muted"></i>
                        <h4 class="text-muted">Select a chat from the left panel</h4>
                        {% if not is_support %}
                            <p class="text-muted">Or start a new conversation with our support team</p>
                            <button class="btn btn-primary mt-3" id="mobileStartChat">
                                <i class="fas fa-plus me-2"></i>Start New Chat
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChatModalLabel">Start a New Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newChatForm">
                    <div class="mb-3">
                        <label for="chatSubject" class="form-label">What do you need help with?</label>
                        <input type="text" class="form-control" id="chatSubject" placeholder="E.g. Order issue, Product inquiry, etc." required>
                    </div>
                    <div class="mb-3">
                        <label for="chatMessage" class="form-label">Initial message</label>
                        <textarea class="form-control" id="chatMessage" rows="3" placeholder="Please provide details of your inquiry..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createChatBtn">Start Chat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const wsToken = "{{ ws_token }}";
        let activeChatRooms = [];
        let newChatModal;
        
        // Initialize pointers to DOM elements
        const startNewChatBtn = document.getElementById('startNewChat');
        const mobileStartChatBtn = document.getElementById('mobileStartChat');
        const chatRoomsList = document.getElementById('chatRoomsList');
        const createChatBtn = document.getElementById('createChatBtn');
        
        // Support staff status toggle
        const supportStatus = document.getElementById('supportStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        
        if (startNewChatBtn) {
            startNewChatBtn.addEventListener('click', openNewChatModal);
        }
        
        if (mobileStartChatBtn) {
            mobileStartChatBtn.addEventListener('click', openNewChatModal);
        }
        
        if (createChatBtn) {
            createChatBtn.addEventListener('click', createNewChat);
        }
        
        // Initialize Bootstrap modal
        newChatModal = new bootstrap.Modal(document.getElementById('newChatModal'));
        
        // Initialize click handlers for chat rooms
        initChatRoomHandlers();
        
        // Support staff status toggle
        if (supportStatus) {
            supportStatus.addEventListener('change', function() {
                updateSupportStatus(this.checked);
            });
        }
        
        // Fetch initial chat rooms data
        fetchChatRooms();
        
        // Poll for updates every 30 seconds
        setInterval(fetchChatRooms, 30000);
        
        function initChatRoomHandlers() {
            const chatCards = document.querySelectorAll('.chat-card');
            chatCards.forEach(card => {
                card.addEventListener('click', function() {
                    const roomId = this.getAttribute('data-room-id');
                    window.location.href = `/chat/room/${roomId}/`;
                });
            });
        }
        
        function openNewChatModal() {
            newChatModal.show();
        }
        
        function createNewChat() {
            const subject = document.getElementById('chatSubject').value.trim();
            const message = document.getElementById('chatMessage').value.trim();
            
            if (!subject || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            // Create new chat via API
            fetch('/chat/api/rooms/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: subject
                })
            })
            .then(response => response.json())
            .then(data => {
                // Store room ID for later use
                const roomId = data.room_id;
                console.log("Created chat room with ID:", roomId);
                
                if (!roomId) {
                    throw new Error("Failed to get room ID from server response");
                }
                
                // Send initial message
                return fetch('/chat/api/messages/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        room_id: roomId,
                        message: message
                    })
                }).then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to send initial message");
                    }
                    return response.json().then(msgData => {
                        return { messageData: msgData, roomId: roomId };
                    });
                });
            })
            .then(data => {
                // Close modal and redirect to the new chat room
                newChatModal.hide();
                window.location.href = `/chat/room/${data.roomId}/`;
            })
            .catch(error => {
                console.error('Error creating chat:', error);
                alert('There was an error creating your chat. Please try again.');
            });
        }
        
        function fetchChatRooms() {
            fetch('/chat/api/rooms/')
                .then(response => response.json())
                .then(data => {
                    activeChatRooms = data;
                    updateChatRoomsList(data);
                })
                .catch(error => console.error('Error fetching chat rooms:', error));
        }
        
        function updateChatRoomsList(rooms) {
            // Update badge counts, etc.
            const chatCards = document.querySelectorAll('.chat-card');
            chatCards.forEach(card => {
                const roomId = card.getAttribute('data-room-id');
                const room = rooms.find(r => r.room_id === roomId);
                if (room) {
                    const badge = card.querySelector('.unread-badge');
                    if (room.unread_count > 0) {
                        badge.textContent = room.unread_count;
                        badge.classList.remove('d-none');
                    } else {
                        badge.classList.add('d-none');
                    }
                }
            });
        }
        
        function updateSupportStatus(isAvailable) {
            // Update support staff status via API
            fetch('/chat/api/staff/set_status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    is_online: isAvailable,
                    is_available: isAvailable
                })
            })
            .then(response => response.json())
            .then(data => {
                // Update UI to reflect new status
                if (statusIndicator) {
                    if (isAvailable) {
                        statusIndicator.classList.add('online');
                        statusIndicator.classList.remove('offline');
                    } else {
                        statusIndicator.classList.add('offline');
                        statusIndicator.classList.remove('online');
                    }
                }
            })
            .catch(error => {
                console.error('Error updating status:', error);
                alert('There was an error updating your status. Please try again.');
                // Reset the toggle to its previous state
                supportStatus.checked = !isAvailable;
            });
        }
        
        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %} 